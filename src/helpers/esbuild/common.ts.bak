import { context, build as esbuild } from "esbuild";

import pc from "picocolors";
import readline from "node:readline";
import { createBuildOptions } from "@/helpers/createBuildOptions";

export const HELP_TEXT = `
Shortcuts
  h + enter   show help
  r + enter   rebuild
  q + enter   quit
`;

export type RunModeOptions = {
  watch: boolean;
  minify?: boolean;
  sourcemap?: boolean;
  hmr: boolean;
};

export type EsbuildContext = Awaited<ReturnType<typeof context>> | null;

export const logShortcuts = () => {
  console.log(`${pc.green(" ➜ ")} press ${pc.bold("h + enter")} to show help`);
  console.log(`${pc.green(" ➜ ")} press ${pc.bold("r + enter")} to rebuild`);
  console.log(`${pc.green(" ➜ ")} press ${pc.bold("q + enter")} to quit`);
  console.log("");
};

export const createCli = (
  ctx: EsbuildContext,
  buildOptions: Parameters<typeof createBuildOptions>[0],
) => {
  const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout,
  });

  const doRebuild = async () => {
    try {
      if (ctx) {
        await ctx.rebuild();
      } else {
        const finalOptions = await createBuildOptions(buildOptions);
        await esbuild(finalOptions);
      }
    } catch {}
  };

  rl.on("line", async (input) => {
    const cmd = input.trim();

    switch (cmd) {
      case "h":
        console.log(HELP_TEXT);
        break;

      case "r":
      case "rs":
        await doRebuild();
        break;

      case "q":
        rl.close();
        process.exit(0);
        break;

      case "":
        break;

      default:
        console.log(`Unknown command: "${cmd}". Press h + enter for help.`);
    }
  });

  rl.on("SIGINT", () => {
    rl.close();
    process.exit(0);
  });

  return rl;
};

export const run = async ({
  watch,
  minify,
  sourcemap,
  hmr,
}: RunModeOptions) => {
  const buildOptionsInput = {
    watch,
    minify,
    sourcemap,
    hmr,
  } as const;

  const buildOptions = await createBuildOptions(buildOptionsInput);

  let ctx: EsbuildContext = null;

  if (watch) {
    ctx = await context(buildOptions);
    await ctx.watch();

    logShortcuts();
    createCli(ctx, buildOptionsInput);
  } else {
    await esbuild(buildOptions);
  }
};
